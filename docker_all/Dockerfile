# ====================================
# å¤šé˜¶æ®µDockeræ„å»º - å‰åç«¯ä¸€ä½“åŒ–éƒ¨ç½²
# ====================================

# é˜¶æ®µ1: åç«¯æ„å»º
FROM gcc:11-bullseye as backend-builder

WORKDIR /app/backend

# é…ç½®å›½å†…è½¯ä»¶æºåŠ é€Ÿ
RUN sed -i 's@http://deb.debian.org@https://mirrors.aliyun.com@g' /etc/apt/sources.list && \
    sed -i 's@http://security.debian.org@https://mirrors.aliyun.com@g' /etc/apt/sources.list

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    cmake \
    build-essential \
    pkg-config \
    git \
    curl \
    wget \
    unzip \
    zip \
    tar \
    libssl-dev \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®vcpkgç¯å¢ƒå˜é‡
ENV VCPKG_ROOT=/opt/vcpkg
ENV CMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake

# å®‰è£…vcpkgåŒ…ç®¡ç†å™¨ï¼ˆæŒ‰ç…§åŸæœ‰æ–¹å¼ï¼‰
RUN echo "ğŸ“¦ é…ç½®vcpkgåŒ…ç®¡ç†å™¨..." && \
    git clone https://github.com/Microsoft/vcpkg.git ${VCPKG_ROOT} && \
    cd ${VCPKG_ROOT} && \
    ./bootstrap-vcpkg.sh

# å®‰è£…C++ä¾èµ–åŒ…
RUN echo "ğŸ“¦ å®‰è£…C++ä¾èµ–åŒ…..." && \
    cd ${VCPKG_ROOT} && \
    ./vcpkg install cpp-httplib nlohmann-json


# å¤åˆ¶åç«¯æºç å¹¶æ„å»º
COPY backend/ ./
RUN echo "ğŸ”§ ç¼–è¯‘åç«¯..." && \
    rm -rf build && \
    mkdir build && cd build && \
    echo "é…ç½®CMake..." && \
    cmake .. \
        -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE} \
        -DCMAKE_BUILD_TYPE=Release && \
    echo "ç¼–è¯‘ä¸­..." && \
    make -j$(nproc) && \
    echo "âœ… ç¼–è¯‘å®Œæˆ"

# é˜¶æ®µ2: å‰ç«¯æ„å»º  
FROM node:18-alpine as frontend-builder

WORKDIR /app/frontend

# ä½¿ç”¨npmå®˜æ–¹æº
RUN npm config set registry https://registry.npmjs.org

# å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–
COPY frontend/package*.json ./
RUN npm install

# å¤åˆ¶æºç å’Œå…±äº«ç±»å‹
COPY frontend/ ./
COPY shared/ ../shared/

# æ„å»ºå‰ç«¯
RUN npm run build

# é˜¶æ®µ3: Nginxä»£ç† + ç”Ÿäº§ç¯å¢ƒ
FROM nginx:alpine

# å®‰è£…å¿…è¦å·¥å…·
RUN apk add --no-cache \
    gettext \
    curl \
    openssl \
    bash

# å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶
COPY --from=backend-builder /app/backend/build/bin/backend /usr/local/bin/

# å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
COPY --from=frontend-builder /app/frontend/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®æ¨¡æ¿
COPY docker_all/nginx.conf.template /etc/nginx/templates/default.conf.template

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY docker_all/docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# åˆ›å»ºSSLè¯ä¹¦ç›®å½•
RUN mkdir -p /etc/nginx/ssl

# æš´éœ²ç«¯å£
EXPOSE 80 443 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/health || exit 1

# å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/docker-entrypoint.sh"] 